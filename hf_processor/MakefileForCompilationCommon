# Copyright (C) 2013 Michel Müller (Typhoon Computing), RIKEN Advanced Institute for Computational Science (AICS)

# This file is part of Hybrid Fortran.

# Hybrid Fortran is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Hybrid Fortran is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public License
# along with Hybrid Fortran. If not, see <http://www.gnu.org/licenses/>.

#***************************************************************************#
#  Makefile that gets copied into the individual build directories.         #
#  Usually nothing needs to be changed here.                                #
#                                                                           #
#  Date             2013/02/01                                              #
#  Author           Michel Müller (RIKEN)                                   #
#***************************************************************************#
include ./MakesettingsGeneral
include ./Makesettings

ifdef VERBOSE
DEBUG_OUTPUT=&1
else
DEBUG_OUTPUT=/dev/null
endif

SRC_FORT=$(wildcard ./*.f90)
SRC_PP=$(wildcard ./*.F90)
SRC=${SRC_FORT} ${SRC_PP}

EXECUTABLES_POST=$(subst ",,${EXECUTABLES})
EXECUTABLES_OUT=$(patsubst %,%.out,${EXECUTABLES_POST})
EXECUTABLES_O=$(patsubst %,%.o,${EXECUTABLES_POST})
#$(warning Executable objects ${EXECUTABLES_O})

OBJ_PRE1=$(SRC:.f90=.o)
OBJ_PRE2=$(OBJ_PRE1:.F90=.o)
OBJ_PRE3=$(patsubst ./%,%,${OBJ_PRE2})
OBJ=$(filter-out $(EXECUTABLES_O),$(OBJ_PRE3))

USER_LIB=libpp.a

.SUFFIXES : .out .o .il .F90 .f90

VPATH=$OBJDIR

all: ${EXECUTABLES_OUT}

%.out: %.o
	@echo ".........linking " $<
	@echo ..calling $(LD) -o ../$@ $< $(LDFLAGS) -L./ >${DEBUG_OUTPUT}
	@$(LD) -o ../$@ $< $(LDFLAGS) ${USER_LIB}

${USER_LIB}: $(OBJ)
	@echo ".........building user library ${USER_LIB} from " $(OBJ)
	@echo ..calling $(AR) $(ARFLAGS) $@ $(OBJ) >${DEBUG_OUTPUT}
	@$(AR) $(ARFLAGS) $@ $(OBJ)

%.o: %.F90
	@echo ..........compiling $< in $(CURDIR)
	@echo ..calling $(FC) $(FFLAGS) -c $< -o $@ >${DEBUG_OUTPUT}
	@$(FC) $(FFLAGS) -c $< -o $@

%.o: %.f90
	@echo ..........compiling $< in $(CURDIR)
	@echo ..calling $(FC) $(FFLAGS) -c $< -o $@ >${DEBUG_OUTPUT}
	@$(FC) $(FFLAGS) -c $< -o $@

helper_functions.o: storage_order.F90
helper_functions_gpu.o: storage_order.F90
time_profiling.o: helper_functions.o

